<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de QI Profissional 2025</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* ... (todo o seu <style> original vai aqui, não mude nada) ... */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0B1120; /* Azul escuro */
            color: #EBF8FF; /* Branco suave */
        }
        
        /* ... (todos os outros estilos) ... */

        /* Estilo para o loader do PIX */
        .pix-loader {
            border-color: var(--color-secondary);
            border-top-color: var(--color-accent);
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <main class="w-full" id="main-container">

        <section id="section-intro" class="quiz-section active max-w-lg mx-auto">
            </section>

        <section id="section-quiz" class="quiz-section max-w-lg mx-auto">
            </section>

        <section id="section-calculating" class="quiz-section max-w-lg mx-auto">
            </section>


        <section id="section-paywall" class="quiz-section max-w-lg mx-auto">
            <div class="bg-gray-900 shadow-2xl rounded-2xl p-6 md:p-10 text-center">
                <i class="fas fa-lock text-4xl text-cyan-400 mb-4"></i>
                <h2 class="text-3xl font-bold mb-3">Seu Relatório de QI está Pronto!</h2>
                
                <div class="bg-gray-800 rounded-lg p-4 my-6">
                    <span class="text-gray-400">Status:</span>
                    <p class="text-2xl font-bold text-green-400">Seu potencial cognitivo foi calculado.</p>
                </div>

                <p class="text-lg text-gray-300 mb-4">Desbloqueie seu Relatório de QI Completo, incluindo gráficos e análises, por apenas:</p>
                <p class="text-5xl font-extrabold text-cyan-400 mb-8">R$ 5,99</p>
                

                <div id="payment-area" class="space-y-6">

                    <button id="generate-pix-button" class="cta-button w-full p-4 rounded-lg text-xl !bg-green-500 hover:!bg-green-600">
                        Pagar com PIX para Gerar Relatório
                    </button>
                    
                    <div id="payment-loader" class="hidden text-center py-10">
                        <div class="pix-loader w-12 h-12 rounded-full border-4 border-t-4 border-cyan-400 border-gray-700 mx-auto mb-4"></div>
                        <p class="text-lg text-cyan-400">Gerando seu PIX seguro...</p>
                    </div>
                    
                    <div id="pix-display" class="hidden space-y-4">
                        <p class="text-xl font-bold text-white">Escaneie o QR Code abaixo:</p>
                        
                        <div id="pix-qr-code-container" class="flex justify-center">
                            </div>
                        
                        <div>
                            <label for="pix-copy-paste" class="font-semibold mb-2 block">Ou use o PIX Copia e Cola:</label> 
                            <textarea id="pix-copy-paste" class="form-input w-full p-3 rounded-lg text-sm text-center" readonly rows="3"></textarea>
                            <button onclick="copyPixKey()" class="mt-2 w-full p-3 rounded-lg bg-gray-700 hover:bg-gray-600 font-semibold">
                                <i class="fas fa-copy mr-2"></i>Copiar Chave
                            </button>
                        </div>

                        <div id="waiting-payment-message" class="py-4">
                            <i class="fas fa-spinner fa-spin text-cyan-400 text-2xl mr-2"></i>
                            <p class="text-xl font-bold text-cyan-400 inline">Aguardando confirmação do pagamento...</p>
                            <p class="text-gray-400 mt-2">Pode levar alguns segundos. Não feche esta página.</p>
                        </div>
                    </div>

                    <div id="payment-error" class="hidden bg-red-800 border border-red-600 text-white p-4 rounded-lg">
                        <strong>Erro:</strong> <span id="payment-error-message"></span>
                    </div>

                </div>
                <div class="flex items-center justify-center space-x-2 text-green-400 text-sm mt-6">
                    <i class="fas fa-shield-halved"></i>
                    <span>Pagamento 100% Seguro via Mercado Pago</span>
                </div>
            </div>
        </section>

        <section id="section-result" class="quiz-section max-w-4xl mx-auto">
            </section>

    </main>
    
    <div id="share-modal" class="hidden ...">
        </div>


    <script>
        // --- 1. BANCO DE DADOS (Perguntas) ---
        // ... (questions array igual) ...
        const questions = [
            { question: "Qual número completa a sequência: 2, 4, 8, 16, ...?", options: ["24", "32", "64", "48"], correct: 1 },
            { question: "Qual palavra não pertence ao grupo?", options: ["Maçã", "Banana", "Batata", "Uva"], correct: 2 },
            { question: "Se 5 gatos pegam 5 ratos em 5 minutos, 1 gato pega 1 rato em quantos minutos?", options: ["1 minuto", "5 minutos", "25 minutos", "10 minutos"], correct: 1 },
            { question: "ÁGUA está para GELO assim como LEITE está para...", options: ["CAFÉ", "QUEIJO", "VACA", "LÍQUIDO"], correct: 1 },
            { question: "Em uma corrida, você ultrapassa o segundo colocado. Em que posição você fica?", options: ["Primeiro", "Segundo", "Terceiro", "Último"], correct: 1 },
            { question: "Qual é o próximo número: 1, 2, 3, 5, 8, ...?", options: ["11", "12", "13", "10"], correct: 2 },
            { question: "Quantos meses têm 28 dias?", options: ["1", "2", "6", "Todos os 12"], correct: 3 },
            { question: "Qual figura completa o padrão? [ ◑ ] [ ◐ ] [ ◒ ] ...", options: ["[ ◓ ]", "[ ● ]", "[ ○ ]", "[ ◑ ]"], correct: 0 },
            { question: "Se 'CIPAFICO' for reorganizado, forma o nome de um:", options: ["País", "Animal", "Oceano", "Cidade"], correct: 2 },
            { question: "Um tijolo pesa 1kg mais meio tijolo. Quanto pesa um tijolo?", options: ["1.5 kg", "2 kg", "2.5 kg", "1 kg"], correct: 1 },
            { question: "Qual das palavras é o oposto de 'PROLIXO'?", options: ["Longo", "Detalhado", "Conciso", "Confuso"], correct: 2 },
            { question: "Se ontem fosse amanhã, hoje seria sexta-feira. Que dia é hoje?", options: ["Quarta-feira", "Quinta-feira", "Sexta-feira", "Domingo"], correct: 0 },
            { question: "Um agricultor tinha 17 ovelhas. Todas, exceto 9, morreram. Quantas restaram?", options: ["0", "8", "9", "17"], correct: 2 },
            { question: "Qual o valor de X em: 2X + 5 = 15?", options: ["10", "7", "4", "5"], correct: 3 },
            { question: "Qual das opções é um mamífero que bota ovos?", options: ["Pinguim", "Morcego", "Ornitorrinco", "Avestruz"], correct: 2 },
            { question: "Qual é o dobro da metade de 100?", options: ["25", "50", "100", "200"], correct: 2 },
            { question: "Qual desses não é um sentido primário?", options: ["Audição", "Paladar", "Intuição", "Tato"], correct: 2 },
            { question: "Se um relógio de 12 horas marca 3:00, qual é o ângulo menor entre os ponteiros?", options: ["90 graus", "100 graus", "45 graus", "0 graus"], correct: 0 },
            { question: "Qual é a capital da Austrália?", options: ["Sydney", "Melbourne", "Canberra", "Brisbane"], correct: 2 },
            { question: "Quantos 9 existem entre 1 e 100?", options: ["10", "11", "19", "20"], correct: 3 }
        ];

        // --- 2. VARIÁVEIS DE ESTADO DO JOGO ---
        let userData = {};
        let userScore = 0;
        let currentQuestionIndex = 0;
        const totalQuestions = questions.length;
        let chartInstances = []; 

        // --- 2.5 NOVA VARIÁVEL DE ESTADO DE PAGAMENTO ---
        let paymentCheckInterval = null; // Guarda o ID do "poller" (setInterval)
        const BACKEND_URL = "http://localhost:3000"; // URL do seu servidor backend

        // --- 3. REFERÊNCIAS DO DOM ---
        // ... (referências antigas) ...
        const mainContainer = document.getElementById('main-container');
        const sections = {
            intro: document.getElementById('section-intro'),
            quiz: document.getElementById('section-quiz'),
            calculating: document.getElementById('section-calculating'),
            paywall: document.getElementById('section-paywall'),
            result: document.getElementById('section-result')
        };
        const introForm = document.getElementById('intro-form');
        // ... (outras referências antigas) ...
        
        // --- NOVAS REFERÊNCIAS DO PAYWALL ---
        const generatePixButton = document.getElementById('generate-pix-button');
        const paymentLoader = document.getElementById('payment-loader');
        const pixDisplay = document.getElementById('pix-display');
        const pixQrCodeContainer = document.getElementById('pix-qr-code-container');
        const pixCopyPasteInput = document.getElementById('pix-copy-paste');
        const paymentError = document.getElementById('payment-error');
        const paymentErrorMessage = document.getElementById('payment-error-message');

        // ... (referências do resultado, como resultGreeting, etc., continuam iguais) ...
        const resultGreeting = document.getElementById('result-greeting');
        const userInfoText = document.getElementById('user-info-text'); 
        const resultScore = document.getElementById('result-score');
        const resultPercentile = document.getElementById('result-percentile');
        const resultAnalysisText = document.getElementById('result-analysis-text');
        const redoQuizButton = document.getElementById('redo-quiz-button');
        const downloadPdfButton = document.getElementById('download-pdf-button');
        const shareButton = document.getElementById('share-button');
        const shareModal = document.getElementById('share-modal');
        const siteLinkInput = document.getElementById('site-link-input');
        const whatsappShare = document.getElementById('whatsapp-share');
        const twitterShare = document.getElementById('twitter-share');

        // --- 4. FUNÇÕES DE LÓGICA ---

        // Função para trocar de seção (tela)
        function showSection(sectionId) {
            // ... (função igual) ...
            if (sectionId === 'result') {
                mainContainer.classList.remove('max-w-lg');
                mainContainer.classList.add('max-w-4xl');
            } else {
                mainContainer.classList.remove('max-w-4xl');
                mainContainer.classList.add('max-w-lg');
            }

            Object.values(sections).forEach(section => {
                section.classList.remove('active');
            });
            sections[sectionId].classList.add('active');
        }

        // ... (funções handleIntroFormInput, startQuiz, displayQuestion, selectAnswer, finishQuiz continuam iguais) ...
        
        function handleIntroFormInput() {
            // ... (igual)
        }

        function startQuiz(event) {
            event.preventDefault();
            userData = {
                name: document.getElementById('user-name').value.trim(),
                lastname: document.getElementById('user-lastname').value.trim(),
                age: document.getElementById('user-age').value.trim()
            };
            userScore = 0;
            currentQuestionIndex = 0;
            
            showSection('quiz');
            displayQuestion();
        }

        function displayQuestion() {
            // ... (igual)
            if (currentQuestionIndex >= totalQuestions) {
                finishQuiz();
                return;
            }
            // ... (resto da função igual)
            const question = questions[currentQuestionIndex];
            
            const qContainer = document.getElementById('question-container');
            qContainer.classList.remove('question-animate');
            void qContainer.offsetWidth; 
            qContainer.classList.add('question-animate');

            const progressPercent = ((currentQuestionIndex + 1) / totalQuestions) * 100;
            document.getElementById('progress-bar').style.width = `${progressPercent}%`;
            document.getElementById('question-counter').innerText = `Pergunta ${currentQuestionIndex + 1}/${totalQuestions}`;

            document.getElementById('question-text').innerText = question.question;
            document.getElementById('answer-options').innerHTML = ''; 

            question.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.innerText = option;
                button.classList.add('option-button', 'w-full', 'p-4', 'rounded-lg', 'text-lg', 'text-left');
                button.onclick = () => selectAnswer(index);
                document.getElementById('answer-options').appendChild(button);
            });
        }
        
        function selectAnswer(selectedIndex) {
            // ... (igual)
             const question = questions[currentQuestionIndex];
            if (selectedIndex === question.correct) {
                userScore++;
            }
            currentQuestionIndex++;
            setTimeout(displayQuestion, 100);
        }

        function finishQuiz() {
            // ... (igual, mas o último timeout chama a NOVA função showPaywall) ...
            showSection('calculating');
            
            const messages = [
                "Analisando suas respostas...",
                "Comparando com nosso banco de dados...",
                "Avaliando raciocínio lógico...",
                "Calculando seu score cognitivo..."
            ];
            let msgIndex = 0;

            document.getElementById('calculating-text').innerText = messages[msgIndex];
            const interval = setInterval(() => {
                msgIndex++;
                if (messages[msgIndex]) {
                    document.getElementById('calculating-text').innerText = messages[msgIndex];
                } else {
                    clearInterval(interval);
                }
            }, 1200);

            setTimeout(() => {
                clearInterval(interval);
                showSection('paywall');
                resetPaywall(); // Garante que o paywall esteja no estado inicial
            }, 5000);
        }


        // --- 4.5. NOVAS FUNÇÕES DE PAGAMENTO ---

        // Reseta o paywall para o estado inicial
        function resetPaywall() {
            // Para qualquer verificação de pagamento anterior
            if (paymentCheckInterval) {
                clearInterval(paymentCheckInterval);
                paymentCheckInterval = null;
            }

            // Mostra o botão de gerar PIX
            generatePixButton.classList.remove('hidden');
            generatePixButton.disabled = false;
            generatePixButton.innerHTML = "Pagar com PIX para Gerar Relatório";
            
            // Esconde as outras seções
            paymentLoader.classList.add('hidden');
            pixDisplay.classList.add('hidden');
            paymentError.classList.add('hidden');
            paymentErrorMessage.innerText = "";
            pixQrCodeContainer.innerHTML = "";
            pixCopyPasteInput.value = "";
        }

        // Função para copiar a chave PIX
        function copyPixKey() {
            pixCopyPasteInput.select();
            pixCopyPasteInput.setSelectionRange(0, 99999); // Para mobile
            try {
                document.execCommand('copy');
                alert('Chave PIX copiada para a área de transferência!');
            } catch (err) {
                alert('Não foi possível copiar. Por favor, copie manualmente.');
            }
        }
        
        // Função principal que inicia o pagamento
        async function initiatePayment() {
            // 1. Mudar a UI para "carregando"
            generatePixButton.classList.add('hidden');
            paymentError.classList.add('hidden');
            paymentLoader.classList.remove('hidden');

            try {
                // 2. Chamar o backend para criar o pagamento
                const response = await fetch(`${BACKEND_URL}/api/create-payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // body: JSON.stringify({ userData: userData }) // Pode enviar dados do usuário se o backend precisar
                });

                if (!response.ok) {
                    throw new Error(`O servidor respondeu com o status ${response.status}`);
                }

                const data = await response.json();
                
                // 3. Mostrar o QR Code e o Copia e Cola
                pixQrCodeContainer.innerHTML = `<img src="data:image/png;base64,${data.qrCodeBase64}" alt="PIX QR Code" class="mx-auto rounded-lg border-4 border-white">`;
                pixCopyPasteInput.value = data.qrCodeCopyPaste;
                
                paymentLoader.classList.add('hidden');
                pixDisplay.classList.remove('hidden');

                // 4. Iniciar o "polling" (verificação de status)
                startPaymentPolling(data.paymentId);

            } catch (error) {
                // 5. Lidar com erros
                console.error("Erro ao iniciar pagamento:", error);
                paymentErrorMessage.innerText = `Não foi possível gerar o PIX. Verifique sua conexão ou tente mais tarde. (${error.message})`;
                paymentLoader.classList.add('hidden');
                paymentError.classList.remove('hidden');
                generatePixButton.classList.remove('hidden'); // Mostra o botão novamente para tentar de novo
            }
        }

        // Função que fica verificando o status do pagamento
        function startPaymentPolling(paymentId) {
            if (paymentCheckInterval) {
                clearInterval(paymentCheckInterval); // Limpa qualquer verificação anterior
            }

            // Verifica a cada 5 segundos
            paymentCheckInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${BACKEND_URL}/api/check-payment/${paymentId}`);
                    
                    if (!response.ok) {
                        // Se houver erro na verificação, para de verificar
                        clearInterval(paymentCheckInterval);
                        console.error("Erro ao verificar status, parando verificações.");
                        return;
                    }

                    const data = await response.json();

                    if (data.status === 'approved') {
                        // 1. PAGAMENTO APROVADO!
                        clearInterval(paymentCheckInterval); // Para a verificação
                        paymentCheckInterval = null;
                        
                        // 2. Mostra uma mensagem de sucesso e gera o relatório
                        console.log("Pagamento Aprovado! Gerando relatório...");
                        document.getElementById('waiting-payment-message').innerHTML = `
                            <i class="fas fa-check-circle text-green-500 text-2xl mr-2"></i>
                            <p class="text-xl font-bold text-green-500 inline">Pagamento Aprovado!</p>
                            <p class="text-gray-400 mt-2">Gerando seu relatório, aguarde...</p>
                        `;

                        // 3. Chama a função de geração de relatório (a original)
                        generateReport();
                    } 
                    // else (se for "pending" ou outro), não faz nada e espera a próxima verificação
                    
                } catch (error) {
                    console.error("Erro no polling:", error);
                    // Não para o polling, pode ser um erro de rede temporário
                }
            }, 5000); // 5000ms = 5 segundos
        }


        // Função que GERA o relatório (AGORA SÓ CHAMADA APÓS O PAGAMENTO)
        // (Sua função 'generateReport' antiga foi renomeada para 'initiatePayment')
        // Esta nova 'generateReport' apenas faz a parte do cálculo e exibição.
        function generateReport() {
            // Esta função agora é chamada DEPOIS que o pagamento é aprovado.
            // O spinner de 2.5s não é mais necessário, ou pode ser um spinner rápido.

            setTimeout(() => {
                try {
                    const result = calculateResult();
                    const staticReport = generateStaticReport(result, userData);
                    displayResults(result, staticReport);
                    showSection('result'); // Finalmente, mostra a seção de resultado

                } catch (error) {
                    console.error("Erro ao gerar relatório:", error);
                    alert("Ocorreu um erro ao gerar seu relatório. Por favor, tente novamente.");
                }
            }, 1500); // Um pequeno delay para o usuário ver a mensagem "Pagamento Aprovado"
        }

        // --- FUNÇÕES DE GERAÇÃO DE RELATÓRIO ESTÁTICO ---
        // ... (getRandomInt, getPercentile, generateStaticReport, calculateResult, displayResults, resetQuiz) ...
        // NENHUMA MUDANÇA NECESSÁRIA AQUI
        function getRandomInt(min, max) { /* ... (igual) ... */ return Math.floor(Math.random() * (max - min + 1)) + min; }
        function getPercentile(iq) { /* ... (igual) ... */ if (iq < 70) return getRandomInt(1, 2); if (iq < 85) return getRandomInt(3, 15); if (iq < 100) return getRandomInt(16, 49); if (iq < 115) return getRandomInt(50, 83); if (iq < 130) return getRandomInt(84, 97); return getRandomInt(98, 99); }
        function generateStaticReport(result, user) { /* ... (igual) ... */ const percentile = getPercentile(result.score); let analysisText = ""; let motto = ""; /* ... (resto da função igual) ... */ return { htmlReport: `...`, percentile: percentile, stats: { logic: 0, speed: 0, memory: 0 } }; }
        function calculateResult() { /* ... (igual) ... */ const iqScore = Math.round((userScore / totalQuestions) * 75 + 70); let profile; if (iqScore < 85) profile = "Inteligência abaixo da média"; else if (iqScore < 115) profile = "Inteligência na média"; else if (iqScore < 130) profile = "Inteligência acima da média"; else profile = "Inteligência muito superior (classificado como superdotação)"; return { score: iqScore, profile: profile }; }
        function displayResults(result, reportData) { /* ... (igual) ... */ resultGreeting.innerText = `Parabéns, ${userData.name}!`; /* ... (resto da função igual) ... */ }
        function resetQuiz() { /* ... (igual) ... */ userData = {}; userScore = 0; currentQuestionIndex = 0; chartInstances.forEach(chart => chart.destroy()); chartInstances = []; /* ... (resto da função igual) ... */ introForm.reset(); handleIntroFormInput(); showSection('intro'); }


        // --- 5. FUNÇÕES DE PDF E COMPARTILHAMENTO ---
        // ... (downloadPDF, shareSite, closeModal, copySiteLink) ...
        // NENHUMA MUDANÇA NECESSÁRIA AQUI
        function downloadPDF() { /* ... (igual) ... */ }
        async function shareSite() { /* ... (igual) ... */ }
        function closeModal(modalId) { /* ... (igual) ... */ }
        function copySiteLink() { /* ... (igual) ... */ }


        // --- 6. EVENT LISTENERS ---

        // Seção 1
        introForm.addEventListener('input', handleIntroFormInput);
        introForm.addEventListener('submit', startQuiz);
        
        // Seção 4 (MODIFICADO)
        // O botão agora chama 'initiatePayment'
        generatePixButton.addEventListener('click', initiatePayment);
        
        // Seção 5 (Ações do Relatório)
        downloadPdfButton.addEventListener('click', downloadPDF);
        shareButton.addEventListener('click', shareSite);
        redoQuizButton.addEventListener('click', resetQuiz);

        // Inicia a aplicação
        document.addEventListener('DOMContentLoaded', () => {
            showSection('intro');
            // handleIntroFormInput(); // Esta função não existe no seu código original, mas é uma boa ideia tê-la
        });

    </script>
</body>
</html>